"use strict";angular.module("jwtApp",["ui.router","ngAnimate","ui.select","ngSanitize","angularSpinner","satellizer","leaflet-directive","ui.bootstrap","angularMoment"]),angular.module("jwtApp").config(["$urlRouterProvider","$stateProvider","$httpProvider","$authProvider","API_URL",function(a,b,c,d,e){a.otherwise("/"),b.state("main",{url:"/",templateUrl:"/views/main.html"}).state("locationset",{url:"/locationset",templateUrl:"/views/locationset.html",controller:"LocationsetCtrl"}).state("register",{url:"/register",templateUrl:"/views/register.html",controller:"RegisterCtrl"}).state("login",{url:"/login",templateUrl:"/views/login.html",controller:"LoginCtrl"}).state("bunches",{url:"/bunches",templateUrl:"/views/bunches.html",controller:"BunchesCtrl"}).state("bunchcreate",{url:"/bunchcreate",templateUrl:"/views/bunchcreate.html",controller:"BunchcreateCtrl"}).state("logout",{url:"/logout",controller:"LogoutCtrl"}),d.google({clientId:"549020993769-tn974vfkrovsr1k4g65135k6m02vec6j.apps.googleusercontent.com",url:e+"auth/google"}),d.facebook({clientId:"1403149849923216",url:e+"auth/facebook"}),d.oauth2({name:"strava",url:e+"auth/strava",clientId:"4728",redirectUri:window.location.origin||window.location.protocol+"//"+window.location.host,response_type:"code",scope:"write",approval_prompt:"force",authorizationEndpoint:"https://www.strava.com/oauth/authorize"}),d.loginUrl=e+"auth/login",d.signupUrl=e+"auth/register",d.loginRedirect="/bunches",c.interceptors.push("authInterceptor"),c.defaults.useXDomain=!0,c.defaults.withCredentials=!0,delete c.defaults.headers.common["X-Requested-With"],c.defaults.headers.common.Accept="application/json",c.defaults.headers.common["Content-Type"]="application/json"}]).constant("API_URL","http://localhost:1337/"),angular.module("jwtApp").directive("validateEquals",function(){return{require:"ngModel",link:function(a,b,c,d){function e(b){var e=b===a.$eval(c.validateEquals);return d.$setValidity("equal",e),e?b:void 0}d.$parsers.push(e),d.$formatters.push(e),a.$watch(c.validateEquals,function(){d.$setViewValue(d.$viewValue)})}}}),angular.module("jwtApp").directive("rideSummary",function(){return{scope:{rides:"="},templateUrl:"/views/rideSummary.html"}}),angular.module("jwtApp").directive("riders",function(){return{restrict:"A",scope:{ride:"=ride"},templateUrl:"/views/riders.html",controller:["$scope","rideServices",function(a,b){a.riders=[],a.$on("someEvent",function(a,b){console.log(b)}),a.populatetab=function(){b.getRiders(a.ride.id).success(function(b){a.riders=b})}}]}}),angular.module("jwtApp").directive("bunchSummary",function(){return{scope:{bunches:"="},templateUrl:"bunchSummary.html"}}),angular.module("jwtApp").service("alert",["$rootScope","$timeout",function(a,b){var c;return function(d,e,f,g){a.close=function(){a.alert.show=!1},a.alert={hasBeenShown:!0,show:!0,type:d,message:f,title:e},b.cancel(c),0!=g&&(c=b(function(){a.alert.show=!1},g||2500))}}]),angular.module("jwtApp").factory("authToken",["$window",function(a){var b,c=a.localStorage,d="userToken",e={setToken:function(a){b=a,c.setItem("userToken",a)},getToken:function(){return b||(b=c.getItem(d)),b},isAuthenticated:function(){return!!e.getToken()},removeToken:function(){b=null,c.removeItem(d)}};return e}]),angular.module("jwtApp").factory("stravaServices",["API_URL","$http",function(a,b){return{getStravaActivities:function(){return b.get(a+"strava/activities")},getStravaActivity:function(c){return b.get(a+"strava/activity?id="+c)}}}]),angular.module("jwtApp").factory("dateServices",function(){return{DaysToAdd:function(a,b){return a>b&&(b+=7),b-a},GetDayNumber:function(a){return"sunday"==a.toLowerCase()||"sun"==a.toLowerCase()?0:"monday"==a.toLowerCase()||"mon"==a.toLowerCase()?1:"tuesday"==a.toLowerCase()||"tue"==a.toLowerCase()?2:"wednesday"==a.toLowerCase()||"wed"==a.toLowerCase()?3:"thursday"==a.toLowerCase()||"thu"==a.toLowerCase()?4:"friday"==a.toLowerCase()||"fri"==a.toLowerCase()?5:"saturday"==a.toLowerCase()||"sat"==a.toLowerCase()?6:void 0}}}),angular.module("jwtApp").factory("locationServices",["API_URL","$http",function(a,b){return{getLocations:function(){return b.get(a+"location")},getUserLocation:function(){return b.get(a+"location/byuser")}}}]),angular.module("jwtApp").factory("rideServices",["API_URL","$http",function(a,b){return{getUserRides:function(){return b.get(a+"ride/byuser")},addRider:function(c){return b.post(a+"ride/addrider",{rideid:c})},removeRider:function(c){return b.post(a+"ride/removerider",{rideid:c})},getRiders:function(c){return b.get(a+"ride/getriders?id="+c)}}}]),angular.module("jwtApp").factory("bunchServices",["API_URL","$http",function(a,b){return{getBunchesByUserandDay:function(c){return b.get(a+"bunch/byuserandday?id="+c)},getBunchesByUsers:function(){return b.get(a+"bunch/byuser")},getBunchesByUserandDayOneOff:function(c){return b.get(a+"bunch/byuseranddayoneoff?id="+c)},createBunch:function(c){return b.post(a+"bunch/create",c)}}}]),angular.module("jwtApp").factory("authInterceptor",["authToken",function(a){return{request:function(b){var c=a.getToken();return c&&(b.headers.Authorization="Bearer "+c),b},response:function(a){return a}}}]),angular.module("jwtApp").controller("HeaderCtrl",["$scope","$auth",function(a,b){a.isAuthenticated=b.isAuthenticated}]),angular.module("jwtApp").controller("LogoutCtrl",["$state","$auth","$http","API_URL",function(a,b,c,d){c.get(d+"auth/logout/"),b.logout(),a.go("main")}]),angular.module("jwtApp").controller("BunchesCtrl",["$scope","$http","API_URL","alert","$state","usSpinnerService","leafletData","locationServices","rideServices","bunchServices","dateServices","moment",function(a,b,c,d,e,f,g,h,i,j,k,l){function m(){a.tabs[l().day()].active=!0,r(),a.$broadcast("someEvent",[1,2,3])}function n(a){null==a&&(d("warning","unable to get bunches! ","No web server?"),e.go("login")),"location_not_set"==a.message?(d("warning","Please set your location",""),e.go("locationset")):(d("warning","unable to get bunches! ",a.message),e.go("login"))}function o(b){angular.forEach(b,function(b){a.markers.push({lat:b.startlocation[0].lat,lng:b.startlocation[0].lng,message:b.name,layer:"rides",zoom:8})})}function p(b){j.getBunchesByUserandDay(b).success(function(b){a.bunches=b,o(b)}).error(n)}function q(b){j.getBunchesByUserandDayOneOff(b).success(function(b){a.oneoffbunches=b,o(b)}).error(n)}function r(){var b=a.active();a.center={},a.markers=[];var c=k.DaysToAdd(k.GetDayNumber(l().format("dddd")),k.GetDayNumber(b.title)),d=l().add(c,"d");p(b.title),q(d.dayOfYear()),a.dayofweekdisplay=d.toDate()}a.tabs=[{title:"Sun"},{title:"Mon"},{title:"Tue"},{title:"Wed"},{title:"Thu"},{title:"Fri"},{title:"Sat"}],a.active=function(){return a.tabs.filter(function(a){return a.active})[0]},a.layers={baselayers:{osm:{name:"mapbox",type:"xyz",url:"http://a.tiles.mapbox.com/v4/craigvl.lc6j9gf5/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiY3JhaWd2bCIsImEiOiJTSEt3NFE0In0.uqpehJUakJt_dPUiaTKLag",layerOptions:{subdomains:["a","b","c"],continuousWorld:!0}}},overlays:{rides:{name:"Rides",type:"markercluster",visible:!0}}},a.refresh=function(){r()},a.addBunch=function(){f.spin("loginSpin"),e.go("bunchcreate")},a.tabclick=function(){r()},a["in"]=function(a){i.addRider(a).success(function(){d("success","You'r in!",""),console.log("success"),r()}).error(n)},a.out=function(a){d("danger","You'r out! ",""),i.removeRider(a).success(function(){r()}).error(n)},h.getUserLocation().success(function(b){a.startlocation=b,a.center={lat:a.startlocation.lat,lng:a.startlocation.lng,zoom:12}}).error(n),m()}]),angular.module("jwtApp").controller("LoginCtrl",["$scope","alert","usSpinnerService","$auth","$state",function(a,b,c,d,e){function f(a){console.log(a.data),console.log(a.message),c.stop("loginSpin"),b("warning","something went wrong! ",a.data.message)}a.authenticate=function(a){c.spin("loginSpin"),d.authenticate(a).then(function(a){null==a.data.user.locationid&&(b("success","Please select a location "),e.go("locationset")),c.stop("loginSpin")})["catch"](f)},a.strava=function(){c.spin("loginSpin")},a.submit=function(){c.spin("loginSpin"),d.login({email:a.email,password:a.password}).then(function(a){b("success","welcome back "+a.data.user.email),c.stop("loginSpin")},f)}}]),angular.module("jwtApp").controller("LocationCtrl",["$scope",function(){}]),angular.module("jwtApp").controller("RegisterCtrl",["$scope","$http","API_URL","alert","$auth","$state",function(a,b,c,d,e,f){a.local={},b.get(c+"location").success(function(b){a.locations=b}).error(function(a){null==a?(d("warning","unable to get locations! ","No web server?"),f.go("login")):(d("warning","unable to get locations! ",a.message),f.go("login"))}),a.submit=function(){e.signup({email:a.email,password:a.password,firstname:a.firstname,lastname:a.lastname,location:a.local.selected}).then(function(a){d("success","Account Created! ","Welcome "+a.data.user.email+"! You have been sent a verification email.")})["catch"](function(a){d("warning","Something went wrong! ",a.data.message)})}}]),angular.module("jwtApp").controller("BunchcreateCtrl",["$scope","$http","API_URL","leafletData","alert","$state","$auth","usSpinnerService","stravaServices","locationServices","bunchServices",function(a,b,c,d,e,f,g,h,i,j,k){function l(){j.getUserLocation().success(function(b){a.startlocation=b,a.cen={lat:a.startlocation.lat,lng:a.startlocation.lng,zoom:13},a.center={lat:a.startlocation.lat,lng:a.startlocation.lng,zoom:13},a.markers={mainMarker:{lat:a.startlocation.lat,lng:a.startlocation.lng,focus:!0,message:"Where does the ride meet?",draggable:!0}}}).error(function(){console.log("unable to get locations"),e("success","Please select a location"),f.go("locationset")}),a.getStravaActivities()}a.routes=[],a.showmap={},a.isstravaauth={},a.minDate=new Date,a.time=new Date(0,0,0,5,30,0,0),a.oneofftime=new Date(0,0,0,5,30,0,0),a.center={},a.paths={},a.cen={},a.oneoffdate=new Date,a.availableDays=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],a.hour={},a.stravaride={},a.hours=["1","2","3","4","5","6","7"],a.multipleSelect={},a.multipleSelect.days=["Tuesday","Thursday"],a.oneoff=!1,a.oneoffradio="No",a.privateradio="No",a["private"]=!1,a.sponsoredradio="No",a.addRoute=function(){a.routes.push({name:a.stravaride.selected.name,activityid:a.stravaride.selected.id,path:a.paths.p1.latlngs})},a.deleteRoute=function(b){a.routes.splice(b,1)},a.getStravaActivities=function(){a.showmap=!1,i.getStravaActivities().success(function(b){a.stravarides=b,a.isstravaauth=!0,a.showmap=!0}).error(function(){a.isstravaauth=!1,a.showmap=!1})},a.stravaAuth=function(){h.spin("createSpin"),g.link("strava",g.getPayload()).then(function(){a.getStravaActivities(),h.stop("createSpin")})["catch"](function(){e("warning","Unable to connect to Strava! ","",4e3),h.stop("createSpin")})},a.getStravaRoute=function(){h.spin("createSpin"),i.getStravaActivity(a.stravaride.selected.id).success(function(b){a.cen={lat:b.startlat,lng:b.startlng,zoom:11},a.paths={p1:{color:"#008000",weight:4,latlngs:b.routearray,layer:"lines"}},h.stop("createSpin")}).error(function(a){e("warning","Strava activities! ",a.message)})},a.layers={baselayers:{osm:{name:"mapbox",type:"xyz",url:"http://a.tiles.mapbox.com/v4/craigvl.lc6j9gf5/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiY3JhaWd2bCIsImEiOiJTSEt3NFE0In0.uqpehJUakJt_dPUiaTKLag",layerOptions:{subdomains:["a","b","c"],continuousWorld:!0}}},overlays:{lines:{name:"Lines",type:"group",visible:!0}}},a.defaults={tileLayer:"http://a.tiles.mapbox.com/v4/craigvl.lc6j9gf5/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiY3JhaWd2bCIsImEiOiJTSEt3NFE0In0.uqpehJUakJt_dPUiaTKLag"},a.$on("leafletDirectiveMap.click",function(b,c){var d=c.leafletEvent;a.markers.mainMarker.lat=d.latlng.lat,a.markers.mainMarker.lng=d.latlng.lng}),a.submit=function(){var b=[{lat:a.markers.mainMarker.lat,lng:a.markers.mainMarker.lng}];a.oneoff="Yes"==a.oneoffradio?!0:!1,a["private"]="Yes"==a.privateradio?!0:!1,a.sponsored="Yes"==a.sponsoredradio?!0:!1;k.createBunch({name:a.name,desc:a.desc,oneoff:a.oneoff,startlocation:b,daysofweek:a.multipleSelect.days,time:a.time,routes:a.routes,oneoffdate:a.oneoffdate,"private":a["private"],sponsored:a.sponsored,sponsorname:a.sponsorname}).success(function(){e("success","Ride created",""),f.go("bunches")}).error(function(){e("warning","Unable to create ride?","")})},l()}]),angular.module("jwtApp").controller("LocationsetCtrl",["$scope","$http","API_URL","$state","alert",function(a,b,c,d,e){a.local={},b.get(c+"location").success(function(b){a.locations=b}).error(function(){}),a.setLocation=function(){b.get(c+"location/setlocation/?id="+a.local.selected.id).success(function(){e("success","Location set",""),d.go("bunches")}).error(function(){})}}]);